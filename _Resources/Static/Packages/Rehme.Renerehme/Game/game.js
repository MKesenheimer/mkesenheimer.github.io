!function(){const t=$("#rehmegame-container").data("debug");function i(){$("#world-animation").addClass("next").on("animationend",function(){$("#world-animation").removeClass("next")})}$.fn.extend({resizeCanvas:function(t,i){var e=$(this)[0];e.width=t,e.height=i}}),calculateForTileSize=function(t,i){for(;t%i!=0;)t++;return t},updateSizes=function(){var t=$(window).outerWidth(),i=calculateForTileSize(t-100,64);t>750&&(i=calculateForTileSize(750,64));var e=calculateForTileSize($(window).outerHeight(),64);$("#rehmegame").resizeCanvas(i,e)},$(window).on("resize",function(){updateSizes()}),updateSizes();var e={jsonStrings:{},loadJson:function(i){var e=this;return new Promise(function(n,s){$.ajax({url:"api/getgame"+i+".json",type:"POST",data:{key:"value"},success:function(s){if("interactions"===i){var o=JSON.parse(s),a=[];o.forEach(function(t){a.push(t.collisionId)}),e.jsonStrings.interactionIds=JSON.stringify(a),t&&console.log(JSON.stringify(a))}if("maps"===i){var r=(o=JSON.parse(s)).layers[1].data;const t=(r=r.filter(u)).indexOf(0);t>-1&&r.splice(t,1),e.jsonStrings.solidIds=JSON.stringify(r)}e.jsonStrings[i]=s,n(s)},error:function(t){s("Could not load json for key: "+i)}})}.bind(this))},getJson:function(t){return t in this.jsonStrings?JSON.parse(this.jsonStrings[t]):null}},n={images:{},loadImage:function(t,i){var e=new Image,n=new Promise(function(n,s){e.onload=function(){this.images[t]=e,n(e)}.bind(this),e.onerror=function(){s("Could not load image: "+i)}}.bind(this));return e.src="_Resources/Static/Packages/Rehme.Renerehme/Game/"+i,n},getImage:function(t){return t in this.images?this.images[t]:null}};class s{constructor(t,i){this.count=0,this.delay=i,this.frame_set=t,this.frame_index=0,this.frame_value=t[0]}animate(){this.count++,this.count>this.delay&&(this.count=0,this.frame_index=this.frame_index==this.frame_set.length-1?0:this.frame_index+1,this.frame_value=this.frame_set[this.frame_index])}}var o={_keys:{},LEFT:37,RIGHT:39,UP:38,DOWN:40,INTERACTING:13,INVENTORY:32,ARROWUP:"arrow_top",ARROWDOWN:"arrow_bottom",ARROWLEFT:"arrow_left",ARROWRIGHT:"arrow_right",ENTER:"enter_button",ESC:"esc_button",CANCEL:27,listenForEvents:function(t){window.addEventListener("touchstart",this._onButtonDown.bind(this)),window.addEventListener("touchend",this._onButtonUp.bind(this)),window.addEventListener("mousedown",this._onButtonDown.bind(this)),window.addEventListener("mouseup",this._onButtonUp.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keyup",this._onKeyUp.bind(this)),t.forEach(function(t){this._keys[t]=!1}.bind(this))},_onKeyDown:function(t){var i=t.keyCode;i in this._keys&&(t.preventDefault(),this._keys[i]=!0)},_onKeyUp:function(t){var i=t.keyCode;i in this._keys&&(t.preventDefault(),this._keys[i]=!1)},_onButtonDown:function(t){var i=t.target.id;i in this._keys&&(t.preventDefault(),this._keys[i]=!0)},_onButtonUp:function(t){var i=t.target.id;i in this._keys&&(t.preventDefault(),this._keys[i]=!1)},_onKeyPress:function(t){var i=t.keyCode;i in this._staticKeys&&(t.preventDefault(),this._staticKeys[i]=!0)},isDown:function(t){if(!t in this._keys)throw new Error("Keycode "+t+" is not being listened to");return this._keys[t]}},a={run:function(t){console.log("loading ..."),this.ctx=t,this._previousElapsed=0;var e=this.load();Promise.all(e).then(function(t){this.init(),console.log("loading complete"),i(),window.requestAnimationFrame(this.tick)}.bind(this))}};a.tick=function(t){window.requestAnimationFrame(this.tick);var i=window.innerWidth,e=window.innerHeight;this.ctx.clearRect(0,0,i,e);var n=(t-this._previousElapsed)/1e3;n=Math.min(n,.25),this._previousElapsed=t,this.update(n),this.render()}.bind(a),window.onload=function(){var t=document.getElementById("rehmegame").getContext("2d");a.run(t)};var r={cols:160,rows:160,tsize:32,layers:[[],[],[],[]],setLayers:function(t){this.layers=t},getTile:function(t,i,e){return this.layers[t][e*r.cols+i]},isSolidTileAtXY:function(t,i){var n=Math.floor(t/this.tsize),s=Math.floor(i/this.tsize);return this.layers.reduce(function(t,i,o){var a=this.getTile(o,n,s),r=e.getJson("solidIds"),h=!1;return-1!==$.inArray(a,r)&&(h=!0),t||h}.bind(this),!1)},canStartInteration:function(t,i){var n=Math.floor(t/this.tsize),s=Math.floor(i/this.tsize);return this.layers.reduce(function(t,i,o){var a=this.getTile(o,n,s),r=e.getJson("interactionIds"),h=!1;return-1!==$.inArray(a,r)&&(h=a),t||h}.bind(this),!1)},canStartOtherStuff:function(t,i){var e=Math.floor(t/this.tsize),n=Math.floor(i/this.tsize);return this.layers.reduce(function(t,i,s){var o=this.getTile(s,e,n),a=!1;return-1!==$.inArray(o,[58])&&(a=o),t||a}.bind(this),!1)},getCol:function(t){return Math.floor(t/this.tsize)},getRow:function(t){return Math.floor(t/this.tsize)},getX:function(t){return t*this.tsize},getY:function(t){return t*this.tsize}};var h={47:new s([47,63,79,95],40),48:new s([48,64,80,96],50),79:new s([79,63,47,95],40),80:new s([80,64,48,96],50),532:new s([532,533,534,548,549,550],50),1155:new s([1155,1156,1157],50),1171:new s([1171,1172,1173],50),1187:new s([1187,1188,1189],50),1202:new s([1202,1218],50),1203:new s([1203,1219,1236],50),1204:new s([1204,1220],50),497:new s([497,498,499,500],50),513:new s([513,514,516,517],50),1057:new s([1057,1059,1061,1089,1091,1093],50),1058:new s([1058,1060,1062,1090,1092,1094],50),1073:new s([1073,1075,1077,1105,1107,1109],50),1074:new s([1074,1076,1078,1106,1108,1110],50),1531:new s([1531,1532,1533,1532],50),1566:new s([1566,1567,1568,1567],50),1534:new s([1534,1535,1536,1535],50),316:new s([316,317,318,319],40),1952:new s([1952,1936],40),355:new s([355,371,372,356],100),948:new s([948,950,952,954,956],50),949:new s([949,951,953,955,957],50),964:new s([964,966,968,970,972],50),965:new s([965,967,969,971,973],50),2416:new s([2416,2415,2414,2398,2414,2415],50),2400:new s([2400,2399,2528,2528,2528,2399],50),2679:new s([2679,2680],1e3),2695:new s([2695,2696],1e3),2657:new s([2657,2659,2661],1e3),2658:new s([2658,2660,2662],1e3),2673:new s([2673,2675,2677],1e3),2674:new s([2674,2676,2678],1e3),2689:new s([2689,2691,2693],1e3),2690:new s([2690,2692,2694],1e3),1207:new s([1207,1210,1213],35),1208:new s([1208,1211,1214],35),1209:new s([1209,1212,1215],35),1223:new s([1223,1226,1229],35),1224:new s([1224,1227,1230],35),1225:new s([1225,1228,1231],35),2429:new s([2429,419,422,425,422,419],50),2430:new s([2430,420,423,426,423,420],50),2431:new s([2431,421,424,427,424,421],50),2445:new s([2445,435,438,441,438,435],50),2446:new s([2446,436,439,442,439,436],50),2447:new s([2447,437,440,443,440,437],50)};function l(t,n){Math.floor(n.x/n.map.tsize),Math.floor(n.y/n.map.tsize);console.log(t);var s=e.getJson("interactions");$.each(s,function(e,s){if(void 0===s.characterPosition&&void 0===s.uuid&&t===s.collisionId){$("#interaction").addClass("show").append('<div id="modular"><div class="modular_top"></div><div class="modular_content"></div><div class="modular_bottom"></div></div>'),new Promise(t=>{$.each(s.dialogs,function(t,i){!0===i.showName&&$(".modular_content").append('<b class="aname">'+i.name+"</b> "),function t(i,e,n,s,o){if(i<e.length){var a=e.charAt(i);" "===a?(n.append('<span class="'+s+'">'+o+"</span>"),o=""):o+=a,i++,setTimeout(function(){t(i,e,n,s,o)},25)}}(0,i.text,$(".modular_content"),i.type,"")}),t(!0)}).then(function(){})}void 0!==s.uuid&&t===s.collisionId&&$.ajax({type:"GET",url:"/api/getcontentbyid",data:{identifier:s.uuid},dataType:"text",cache:!1,beforeSend:function(){},complete:function(){},success:function(t){var i='<div id="modular" class="modular-blog"><div class="close-modular">X</div><div class="modular_top"></div><div class="modular_content">'+t+'</div><div class="modular_bottom"></div></div>';$("#interaction").addClass("show").append(i),$(".close-modular").click(function(){n.inInteraction=!1,$("#modular").remove()})}}),void 0!==s.characterPosition&&t===s.collisionId&&(n.x=s.coordinateX,n.y=s.coordinateY,n.heroLastPosition=s.characterPosition,s.stopInteraction&&(n.inInteraction=!1),i())})}function c(t,i,e){this.x=0,this.y=0,this.width=i,this.height=e,this.maxX=t.cols*t.tsize-i,this.maxY=t.rows*t.tsize-e}function d(t,i,e){this.map=t,this.x=i,this.y=e,this.width=2*t.tsize-20,this.height=2*t.tsize-34,this.heroCurrentPosition=0,this.heroLastPosition="hero_walks_down02",this.image=n.getImage("hero_walks_down02"),this.inInteraction=!1}function u(t,i,e){return e.indexOf(t)===i}c.prototype.follow=function(t){this.following=t,t.screenX=0,t.screenY=0},c.prototype.update=function(){var t=this;$(window).on("resize",function(){var i=$(window).outerWidth(),e=calculateForTileSize(i-100,64);i>750&&(e=calculateForTileSize(750,64));var n=calculateForTileSize($(window).outerHeight(),64);t.height=n,t.width=e,t.maxX=r.cols*r.tsize-e,t.maxY=r.rows*r.tsize-n}),this.following.screenX=this.width/2-10,this.following.screenY=this.height/2-38,this.x=this.following.x-this.width/2,this.y=this.following.y-this.height/2,this.x=Math.max(0,Math.min(this.x,this.maxX)),this.y=Math.max(0,Math.min(this.y,this.maxY)),(this.following.x<this.width/2||this.following.x>this.maxX+this.width/2)&&(this.following.screenX=this.following.x-this.x-10),(this.following.y<this.height/2||this.following.y>this.maxY+this.height/2)&&(this.following.screenY=this.following.y-this.y-38)},d.SPEED=200,d.prototype.interaction=function(t,i){if(!this.inInteraction){var e=this.x-this.width/2,n=e+32,s=e-1,o=this.x+this.width/2-1,a=o+1,r=this.y-this.height/2-1,h=this.y+this.height/2,c=!1,d=this.map;if("hero_walks_up02"==this.heroLastPosition&&(c=d.canStartInteration(o,r)||d.canStartInteration(e,r)||d.canStartInteration(n,r)),"hero_walks_down02"==this.heroLastPosition&&(c=d.canStartInteration(o,h)||d.canStartInteration(e,h)||d.canStartInteration(n,h)),"hero_walks_left02"==this.heroLastPosition&&(c=d.canStartInteration(s,r)||d.canStartInteration(s,h)),"hero_walks_right02"==this.heroLastPosition&&(c=d.canStartInteration(a,r)||d.canStartInteration(a,h)),!c)return;this.inInteraction||(this.inInteraction=!0,l(c,this))}},d.prototype.move=function(t,i,e){if(!this.inInteraction){this.x+=i*d.SPEED*t,this.y+=e*d.SPEED*t,this._collide(i,e);var s=this.map.cols*this.map.tsize,o=this.map.rows*this.map.tsize;this.x=Math.max(0,Math.min(this.x,s)),this.y=Math.max(0,Math.min(this.y,o)),0===i&&0===e&&(this.image=n.getImage(this.heroLastPosition)),-1===e&&(this._animationWalk("hero_walks_up"),this.heroLastPosition="hero_walks_up02"),1===e&&(this._animationWalk("hero_walks_down"),this.heroLastPosition="hero_walks_down02"),-1===i&&(this._animationWalk("hero_walks_left"),this.heroLastPosition="hero_walks_left02"),1===i&&(this._animationWalk("hero_walks_right"),this.heroLastPosition="hero_walks_right02")}},d.prototype._animationWalk=function(t){this.heroCurrentPosition++,this.heroCurrentPosition>10&&this.heroCurrentPosition<20&&(this.image=n.getImage(t+"01")),this.heroCurrentPosition>20&&this.heroCurrentPosition<30&&(this.image=n.getImage(t+"02")),this.heroCurrentPosition>30&&(this.image=n.getImage(t+"03"),this.heroCurrentPosition=0)},d.prototype._collide=function(t,i){var e,n,s=this.x-this.width/2,o=s+32,a=this.x+this.width/2-1,r=this.y-this.height/2,h=this.y+this.height/2-1,l=this.map,c=l.canStartOtherStuff(s,r)||l.canStartOtherStuff(o,r)||l.canStartOtherStuff(a,r)||l.canStartOtherStuff(a,h)||l.canStartOtherStuff(s,h)||l.canStartOtherStuff(o,h);d.SPEED=c?95:200,(l.isSolidTileAtXY(s,r)||l.isSolidTileAtXY(o,r)||l.isSolidTileAtXY(a,r)||l.isSolidTileAtXY(a,h)||l.isSolidTileAtXY(s,h)||l.isSolidTileAtXY(o,h))&&(i>0?(e=l.getRow(h),this.y=-this.height/2+this.map.getY(e)):i<0?(e=l.getRow(r),this.y=this.height/2+this.map.getY(e+1)):t>0?(n=l.getCol(a),this.x=-this.width/2+this.map.getX(n)):t<0&&(n=l.getCol(s),this.x=this.width/2+this.map.getX(n+1)))},a.load=function(){return function(t){this.map=t}(r),[e.loadJson("interactions"),e.loadJson("quests"),e.loadJson("maps"),n.loadImage("tiles","assets/game_tiles.png"),n.loadImage("hero_walks_down01","assets/hero_walks_down01.png"),n.loadImage("hero_walks_down02","assets/hero_walks_down02.png"),n.loadImage("hero_walks_down03","assets/hero_walks_down03.png"),n.loadImage("hero_walks_up01","assets/hero_walks_up01.png"),n.loadImage("hero_walks_up02","assets/hero_walks_up02.png"),n.loadImage("hero_walks_up03","assets/hero_walks_up03.png"),n.loadImage("hero_walks_left01","assets/hero_walks_left01.png"),n.loadImage("hero_walks_left02","assets/hero_walks_left02.png"),n.loadImage("hero_walks_left03","assets/hero_walks_left03.png"),n.loadImage("hero_walks_right01","assets/hero_walks_right01.png"),n.loadImage("hero_walks_right02","assets/hero_walks_right02.png"),n.loadImage("hero_walks_right03","assets/hero_walks_right03.png")]},a.init=function(){var t=e.getJson("maps");mapLayers={layers:[t.layers[0].layers[0].data,t.layers[0].layers[1].data,t.layers[0].layers[2].data,t.layers[0].layers[3].data]},existingMap=function(){return this.map}(),r=$.extend({},existingMap,mapLayers),o.listenForEvents([o.LEFT,o.RIGHT,o.UP,o.DOWN,o.INTERACTING,o.INVENTORY,o.ARROWUP,o.ARROWDOWN,o.ARROWLEFT,o.ARROWRIGHT,o.ENTER,o.ESC,o.CANCEL]),this.tileAtlas=n.getImage("tiles"),this.hero=new d(r,657,1915);var s=$(window).outerWidth(),a=calculateForTileSize(s-100,64);s>750&&(a=calculateForTileSize(750,64));var h=calculateForTileSize($(window).outerHeight(),64);this.camera=new c(r,a,h),this.camera.follow(this.hero),function(t,e){const n=$("#music-control"),s=n.find("i"),o=$("audio")[0];n.click(function(){o.paused?(o.volume=.2,o.play(),s.removeClass("fa-volume-up"),s.addClass("fa-volume-mute")):(o.pause(),s.removeClass("fa-volume-mute"),s.addClass("fa-volume-up")),n.toggleClass("pulse")}),$(".icon1").on("click",function(){t.hero.x=1170,t.hero.y=2980,t.hero.heroLastPosition="hero_walks_up02",i()}),$(".icon2").click(function(){t.hero.x=490,t.hero.y=2980,t.hero.heroLastPosition="hero_walks_up02",i()}),$(".icon3").click(function(){t.hero.x=570,t.hero.y=4580,t.hero.heroLastPosition="hero_walks_up02",i()}),$(".icon4").click(function(){t.hero.x=2640,t.hero.y=4450,t.hero.heroLastPosition="hero_walks_up02",i()}),$(".icon5").click(function(){var t=new URL(window.location);window.location.href=t.origin})}(this)},a.update=function(t){var i=0,e=0;o.isDown(o.LEFT)||o.isDown(o.ARROWLEFT)?i=-1:o.isDown(o.RIGHT)||o.isDown(o.ARROWRIGHT)?i=1:o.isDown(o.UP)||o.isDown(o.ARROWUP)?e=-1:(o.isDown(o.DOWN)||o.isDown(o.ARROWDOWN))&&(e=1),this.hero.move(t,i,e),(o.isDown(o.INTERACTING)||o.isDown(o.ENTER))&&this.hero.interaction(i,e),(o.isDown(o.CANCEL)||o.isDown(o.ESC))&&(this.hero.inInteraction=!1,$("#modular").remove()),this.camera.update()},a._drawLayer=function(t){var i=Math.floor(this.camera.x/r.tsize),e=i+this.camera.width/r.tsize,n=Math.floor(this.camera.y/r.tsize),s=n+this.camera.height/r.tsize,o=-this.camera.x+i*r.tsize,a=-this.camera.y+n*r.tsize;Object.values(h).forEach(t=>{t.animate()});for(var l=i;l<=e;l++)for(var c=n;c<=s;c++){var d=r.getTile(t,l,c);h[d]&&(d=h[d].frame_value);var u=(l-i)*r.tsize+o,w=(c-n)*r.tsize+a;if(0!==d){var f=(d-1)%16*r.tsize,m=~~((d-1)/16)*r.tsize;this.ctx.drawImage(this.tileAtlas,f,m,r.tsize,r.tsize,Math.round(u),Math.round(w),r.tsize,r.tsize)}}},a._drawGrid=function(){for(var i,e,n=r.cols*r.tsize,s=r.rows*r.tsize,o=0;o<r.rows;o++)i=-this.camera.x,e=o*r.tsize-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(i,e),t&&this.ctx.lineTo(n,e),this.ctx.stroke();for(var a=0;a<r.cols;a++)i=a*r.tsize-this.camera.x,e=-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(i,e),t&&this.ctx.lineTo(i,s),this.ctx.stroke()},a.render=function(){this._drawLayer(0),this._drawLayer(1),this._drawLayer(2),this.ctx.drawImage(this.hero.image,this.hero.screenX-this.hero.width/2,this.hero.screenY-this.hero.height/2),this._drawLayer(3),this._drawGrid()}}();